#!/bin/sh

# Wait a little for devices to appear.
sleep 2

# Mount the necessary filesystems.
# We need /proc to mount anything, /dev to mount /boot,
# and /boot for the new root image.
mount /proc
mount /dev
mount /boot
# XXX debugging: break into a shell
#sh

# Switch to the real root.
mkdir /newroot
mount -tsquashfs /boot/baseroot.sqfs /boot/baseroot
mount -tsquashfs /boot/osroot.sqfs /boot/osroot
mount -toverlay overlay -olowerdir=/boot/osroot:/boot/baseroot /newroot
mount --move /proc /newroot/proc
mount --move /dev /newroot/dev
mount --move /boot /newroot/boot
# XXX debugging: leave old root visible under the new root
#mount --bind / /newroot/mnt
exec switch_root /newroot /init1
